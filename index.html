<!-- index.html (fixed) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Evaluation summary</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Lato', sans-serif; margin: 2rem; min-height: 100vh; }
    h1, h2 { color: #4F2683; }
    button {
      font-size: 1.0rem; font-weight: bold; padding: 0.6rem 1.3rem;
      background-color: #7e57c2; color: white; border: none; border-radius: 6px; cursor: pointer;
    }
    button:hover { background-color: #6a4bb3; }
    select { font-size: 1.0rem; margin-left: 0.5rem; }
    .selector-row { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.5rem; }
    .input-group { display: flex; gap: 2rem; align-items: flex-start; margin-bottom: 2rem; }
    .input-box, .sample-box { flex: 1; max-width: 600px; }
    textarea { font-family: monospace; width: 100%; }
    .sample-content {
      background: #f9f9f9; border: 1px solid #ccc; padding: 0.5rem;
      font-family: monospace; white-space: pre-wrap; max-height: 150px; overflow-y: auto; cursor: text;
    }
    #response {
      white-space: pre-wrap; margin-top: 1rem; padding: 1rem;
      background: #f4f4f4; border: 1px solid #ccc; max-width: 600px;
    }
  </style>
</head>
<body>
  <h2> Feedback Mechanism</h2>

  <div class="selector-row">
    <label for="botMode"><strong>Select a course:</strong></label>
    <select id="botMode"></select>

    <label for="assessmentMode"><strong>Select an assessment:</strong></label>
    <select id="assessmentMode"></select>
  </div>

  <p id="contentStatus" style="margin-top: 0.5rem; color: #4F2683;"></p>
  <hr />

  <form id="queryForm">
    <div class="input-group">
      <div class="input-box">
        <label for="instructor">Reviewer Essay Comments:</label><br />
        <textarea name="instructor" id="instructor" rows="4" cols="60" placeholder="Enter your comments here..."></textarea>
      </div>
      <div class="sample-box">
        <label>Sample Feedback:</label>
        <div class="sample-content">
Excellent writing, strong clear engagement with the course readings.
Very well argued paper with lots of examples and a close reading of the text.
        </div>
      </div>
    </div>

    <div class="input-group">
      <div class="input-box">
        <label for="essay">Essay for submission:</label><br />
        <textarea name="essay" id="essay" rows="10" cols="60" placeholder="Paste the student essay here..."></textarea>
      </div>
      <div class="sample-box">
        <label>Sample Essay:</label>
        <div class="sample-content">
Introduction
Paste a sample essay here if you want; this text is only a placeholder.
        </div>
      </div>
    </div>

    <p><em>All submissions and responses are stored with Qualtrics. NEVER include any personal identifiers.</em></p>
    <button type="submit">Submit</button>
  </form>

  <h3>Response:</h3>
  <pre id="response"></pre>

  <script>
    const form = document.getElementById("queryForm");
    const responseBox = document.getElementById("response");
    const botMode = document.getElementById("botMode");
    const assessmentMode = document.getElementById("assessmentMode");
    const contentStatus = document.getElementById("contentStatus");

    const contentConfig = {
      syllabiPath: "syllabi",
      assessmentsPath: "assessments",
    };

    // FIX: Always have a working default for web hosting that is NOT *.github.io (custom domain, etc.)
    // You can still override via URL: ?owner=ORG&repo=REPO&branch=BRANCH
    const DEFAULT_GITHUB = { owner: "dbousfie", repo: "feedback", branch: "main" };

    const inferGitHubConfig = () => {
      const params = new URLSearchParams(window.location.search);
      const paramOwner = params.get("owner");
      const paramRepo = params.get("repo");
      const paramBranch = params.get("branch");
      if (paramOwner && paramRepo) {
        return { owner: paramOwner, repo: paramRepo, branch: paramBranch || "main" };
      }

      const host = window.location.hostname;
      const pathParts = window.location.pathname.split("/").filter(Boolean);

      // Standard GitHub Pages pattern: https://OWNER.github.io/REPO/
      if (host.endsWith(".github.io")) {
        const owner = host.replace(".github.io", "");
        const repo = pathParts.length > 0 ? pathParts[0] : `${owner}.github.io`;
        return { owner, repo, branch: "main" };
      }

      // FIX: fallback for custom domain / other hosting
      return DEFAULT_GITHUB;
    };

    const githubConfig = inferGitHubConfig();
    const syllabusMap = new Map();
    let assessmentFiles = [];

    const setStatus = (message) => { contentStatus.textContent = message; };

    const setSelectOptions = (select, options, placeholder) => {
      select.innerHTML = "";
      if (options.length === 0) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = placeholder;
        option.disabled = true;
        option.selected = true;
        select.appendChild(option);
        select.disabled = true;
        return;
      }
      select.disabled = false;
      options.forEach((optionData, index) => {
        const option = document.createElement("option");
        option.value = optionData.value;
        option.textContent = optionData.label;
        if (index === 0) option.selected = true;
        select.appendChild(option);
      });
    };

    const fetchFolderContents = async (path) => {
      const cacheBuster = Date.now();
      const apiUrl =
        `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${path}?ref=${githubConfig.branch}&cache=${cacheBuster}`;
      const res = await fetch(apiUrl, { cache: "no-store" });
      if (!res.ok) {
        throw new Error(`Unable to load ${path} from GitHub (${githubConfig.owner}/${githubConfig.repo}@${githubConfig.branch}).`);
      }
      const data = await res.json();
      return data.filter((item) => item.type === "file" && item.name.endsWith(".md"));
    };

    const fetchMarkdown = async (url, fallbackText) => {
      if (!url) return fallbackText !== undefined ? fallbackText : "";
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("Unable to load selected content file.");
      return res.text();
    };

    const loadContentOptions = async () => {
      setStatus(`Loading from GitHub: ${githubConfig.owner}/${githubConfig.repo} (${githubConfig.branch})...`);
      setSelectOptions(botMode, [], "Loading courses...");
      setSelectOptions(assessmentMode, [], "Loading assessments...");

      const [syllabi, assessments] = await Promise.all([
        fetchFolderContents(contentConfig.syllabiPath),
        fetchFolderContents(contentConfig.assessmentsPath),
      ]);

      syllabusMap.clear();
      const syllabusOptions = syllabi.map((item) => {
        const course = item.name.replace(/syllabus\.md$/i, "");
        syllabusMap.set(course, item.download_url);
        return { value: course, label: course };
      });
      setSelectOptions(botMode, syllabusOptions, "No courses found.");

      assessmentFiles = assessments.map((item) => ({
        name: item.name,
        downloadUrl: item.download_url,
      }));

      const assessmentOptions = assessmentFiles.map((item) => ({
        value: item.downloadUrl,
        label: item.name.replace(/\.md$/i, ""),
      }));
      setSelectOptions(assessmentMode, assessmentOptions, "No assessments found.");

      setStatus("Loaded.");
    };

    loadContentOptions().catch((error) => {
      setStatus(error.message);
      responseBox.textContent = "Error loading course content.";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      responseBox.textContent = "Loading...";

      const instructor = document.getElementById("instructor").value;
      const essay = document.getElementById("essay").value;
      const syllabusUrl = syllabusMap.get(botMode.value);
      const assessmentUrl = assessmentMode.value;

      const combinedQuery = `
db2025
The instructor’s in-text comments are authoritative and must guide all feedback. Do not override, soften, or generalize them.

# Instructor Comments:
${instructor}

# Student Essay:
${essay}

Please provide structured feedback under the six db2025 categories. Feedback must be concise, evaluative, and written in the instructor’s voice.
      `.trim();

      try {
        const [syllabusContent, assessmentContent] = await Promise.all([
          fetchMarkdown(syllabusUrl, "No syllabus loaded."),
          fetchMarkdown(assessmentUrl, "No assessment selected."),
        ]);

        const res = await fetch("https://essayfeedback-bot.deno.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: combinedQuery,
            course: botMode.value,
            syllabus: syllabusContent,
            assessment: assessmentContent,
          }),
        });

        const text = await res.text();
        responseBox.textContent = text;
      } catch (err) {
        responseBox.textContent = "Error contacting server.";
      }
    });
  </script>
</body>
</html>
