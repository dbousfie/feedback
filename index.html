<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Evaluation summary</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Lato', sans-serif;
      margin: 2rem;
      min-height: 100vh;
    }
    h1, h2 {
      color: #4F2683;
    }
    button {
      font-size: 1.0rem;
      font-weight: bold;
      padding: 0.6rem 1.3rem;
      background-color: #7e57c2;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background-color: #6a4bb3;
    }
    select {
      font-size: 1.0rem;
      margin-left: 0.5rem;
    }
    .selector-row {
      display: flex;
      gap: 1rem;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 0.5rem;
    }
    .input-group {
      display: flex;
      gap: 2rem;
      align-items: flex-start;
      margin-bottom: 2rem;
    }
    .input-box, .sample-box {
      flex: 1;
      max-width: 600px;
    }
    textarea {
      font-family: monospace;
      width: 100%;
    }
    .sample-content {
      background: #f9f9f9;
      border: 1px solid #ccc;
      padding: 0.5rem;
      font-family: monospace;
      white-space: pre-wrap;
      max-height: 150px;
      overflow-y: auto;
      cursor: text;
    }
    #response {
      white-space: pre-wrap;
      margin-top: 1rem;
      padding: 1rem;
      background: #f4f4f4;
      border: 1px solid #ccc;
      max-width: 600px;
    }
  </style>
</head>
<body>
  <h2> Feedback Mechanism</h2>
  <div class="selector-row">
    <label for="botMode"><strong>Select a course:</strong></label>
    <select id="botMode"></select>
    <label for="assessmentMode"><strong>Select an assessment:</strong></label>
    <select id="assessmentMode"></select>
  </div>
  <p id="contentStatus" style="margin-top: 0.5rem; color: #4F2683;"></p>
  <hr />
  <form id="queryForm">
    <div class="input-group">
      <div class="input-box">
        <label for="instructor">Reviewer Essay Comments:</label><br />
        <textarea name="instructor" id="instructor" rows="4" cols="60" placeholder="Enter your comments here..."></textarea>
      </div>
      <div class="sample-box">
        <label>Sample Feedback:</label>
        <div class="sample-content">
          Excellent writing, strong clear engagement with the course readings. Very well argued paper with lots of examples and a close reading of the text synthesized with textbook. Excellent work.
        </div>
      </div>
    </div>
    <div class="input-group">
      <div class="input-box">
        <label for="essay">Essay for submission:</label><br />
        <textarea name="essay" id="essay" rows="10" cols="60" placeholder="Paste the student essay here..."></textarea>
      </div>
      <div class="sample-box">
        <label>Sample Essay:</label>
        <div class="sample-content">
          Introduction
       The common concept of sovereignty in international affairs is not a neutral or benign organizing principle. Rather, it is historically based in colonialism and continues to perpetrate systemic racism and structural violence against Indigenous populations globally. As Meghana Nayak and Eric Selbin explain, “lurking behind our passports and citizenship status is the native – the denial, murder, and enslavement of whom made possible the modern nation-state” (Nayak and Selbin 2010: 25). This sharp judgment highlights the basic conflict in International Relations theory’s approach of sovereignty. While IR experts date contemporary sovereignty to the Peace of Westphalia in 1648, presenting it as coming from diplomatic agreement among civilized European powers, this genesis story conceals sovereignty’s underlying foundation in the systematic brutality against Indigenous peoples. The documents that grant us citizenship, the borders that define our states, and the institutions that control international relations all rest upon what Nayak and Selbin characterize as the ‘denial’ of Indigenous political presence. Contemporary IR theory has institutionalized this denial, treating the nation-state system as universal while declaring Indigenous sovereignties invisible or illegitimate. To expose these foundational violences, this essay employs a decolonial methodology that questions the epistemic assumptions underlying standard IR theory. As Erick Viramontes argues, “Decolonizing knowledge entails, in general terms, resisting the underlying criteria of modernity/coloniality for assessing the value of knowledge, while promoting, through institutional designs, a true dialog among knowledges” (Viramontes 2022: 47). This method demonstrates how IR’s adherence to allegedly universal ideas like sovereignty actually reproduces what Viramontes characterizes as the “hierarchy of knowledge” that promotes Western ways of understanding politics while marginalizing Indigenous political thought (Viramontes 2022: 46). Rather than considering Indigenous resistance as a deviation from appropriate governance, a decolonial lens views Indigenous political practices as viable alternatives that expose sovereignty’s colonial origins. This essay advances three interconnected arguments: first, that conventional sovereignty is fundamentally colonial and perpetuates systemic violence against Indigenous peoples; second, that Indigenous resistance constitutes an ongoing response to the violence embedded within the liberal international order; and third, that Indigenous sovereignties offer legitimate alternatives that challenge IR theory’s colonial assumptions. Through this decolonial perspective, Indigenous survival and resistance emerge not as hurdles to international order, but as vital interventions that disclose sovereignty’s actual nature as a tool of racial oppression.
  Historical Foundations of Colonial Sovereignty
      ...
        </div>
      </div>
    </div>
    <p><em>All submissions and responses are stored with Qualtrics. NEVER include any personal identifiers.</em></p>
    <button type="submit">Submit</button>
  </form>
  <h3>Response:</h3>
  <pre id="response"></pre>
  <script>
    const form = document.getElementById("queryForm");
    const responseBox = document.getElementById("response");
    const botMode = document.getElementById("botMode");
    const assessmentMode = document.getElementById("assessmentMode");
    const contentStatus = document.getElementById("contentStatus");

    const contentConfig = {
      syllabiPath: "syllabi",
      assessmentsPath: "assessments",
    };

    const inferGitHubConfig = () => {
      const params = new URLSearchParams(window.location.search);
      const paramOwner = params.get("owner");
      const paramRepo = params.get("repo");
      const paramBranch = params.get("branch");
      if (paramOwner && paramRepo) {
        return { owner: paramOwner, repo: paramRepo, branch: paramBranch || "main" };
      }

      const host = window.location.hostname;
      const pathParts = window.location.pathname.split("/").filter(Boolean);
      if (host.endsWith(".github.io")) {
        const owner = host.replace(".github.io", "");
        const repo = pathParts.length > 0 ? pathParts[0] : `${owner}.github.io`;
        return { owner, repo, branch: "main" };
      }

      return { owner: "", repo: "", branch: "main" };
    };

    const githubConfig = inferGitHubConfig();
    const syllabusMap = new Map();
    let assessmentFiles = [];

    const setStatus = (message) => {
      contentStatus.textContent = message;
    };

    const setSelectOptions = (select, options, placeholder) => {
      select.innerHTML = "";
      if (options.length === 0) {
        const option = document.createElement("option");
        option.value = "";
        option.textContent = placeholder;
        option.disabled = true;
        option.selected = true;
        select.appendChild(option);
        select.disabled = true;
        return;
      }
      select.disabled = false;
      options.forEach((optionData, index) => {
        const option = document.createElement("option");
        option.value = optionData.value;
        option.textContent = optionData.label;
        if (index === 0) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    };

    const fetchFolderContents = async (path) => {
      if (!githubConfig.owner || !githubConfig.repo) {
        throw new Error("Missing GitHub owner or repo. Provide ?owner=ORG&repo=REPO in the URL.");
      }
      const apiUrl = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}/contents/${path}?ref=${githubConfig.branch}`;
      const res = await fetch(apiUrl);
      if (!res.ok) {
        throw new Error(`Unable to load ${path} from GitHub.`);
      }
      const data = await res.json();
      return data.filter((item) => item.type === "file" && item.name.endsWith(".md"));
    };

    const fetchMarkdown = async (url, fallbackText) => {
      if (!url) {
        if (fallbackText !== undefined) {
          return fallbackText;
        }
        throw new Error("Missing content file URL.");
      }
      const res = await fetch(url);
      if (!res.ok) {
        throw new Error("Unable to load selected content file.");
      }
      return res.text();
    };

    const loadContentOptions = async () => {
      setStatus("Loading syllabus and assessment lists from GitHub...");
      setSelectOptions(botMode, [], "Loading courses...");
      setSelectOptions(assessmentMode, [], "Loading assessments...");
      const [syllabi, assessments] = await Promise.all([
        fetchFolderContents(contentConfig.syllabiPath),
        fetchFolderContents(contentConfig.assessmentsPath),
      ]);

      syllabusMap.clear();
      const syllabusOptions = await Promise.all(
        syllabi.map(async (item) => {
          const course = item.name.replace(/syllabus\.md$/i, "");
          syllabusMap.set(course, item.download_url);
          let label = course;
          try {
            const text = await fetchMarkdown(item.download_url);
            const match = text.match(/^#\s+(.+)$/m);
            if (match) {
              label = match[1].trim();
            }
          } catch (error) {
            console.warn("Unable to load syllabus title.", error);
          }
          return { value: course, label };
        })
      );
      setSelectOptions(botMode, syllabusOptions, "No courses found.");

      assessmentFiles = assessments.map((item) => ({
        name: item.name,
        downloadUrl: item.download_url,
      }));

      updateAssessmentOptions();
      setStatus("Content lists loaded.");
    };

    const updateAssessmentOptions = () => {
      const course = botMode.value;
      const filtered = assessmentFiles.filter((item) =>
        item.name.toLowerCase().startsWith(course.toLowerCase())
      );

      const assessmentOptions = filtered.map((item) => {
        const baseLabel = item.name.replace(/\.md$/i, "");
        const coursePrefix = new RegExp(`^${course}[-_\\s]*`, "i");
        const label = baseLabel.replace(coursePrefix, "") || baseLabel;
        return { value: item.downloadUrl, label };
      });

      setSelectOptions(assessmentMode, assessmentOptions, "No assessments found.");
    };

    botMode.addEventListener("change", updateAssessmentOptions);

    loadContentOptions().catch((error) => {
      setStatus(error.message);
      responseBox.textContent = "Error loading course content. Check GitHub settings.";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      responseBox.textContent = "Loading...";

      const instructor = document.getElementById("instructor").value;
      const essay = document.getElementById("essay").value;
      const syllabusUrl = syllabusMap.get(botMode.value);
      const assessmentUrl = assessmentMode.value;

      const combinedQuery = `
  db2025
  The instructor’s in-text comments are authoritative and must guide all feedback. Do not override, soften, or generalize them.

  # Instructor Comments:
  ${instructor}

  # Student Essay:
  ${essay}

  Please provide structured feedback under the six db2025 categories. Feedback must be concise, evaluative, and written in the instructor’s voice.
      `.trim();

      try {
        const [syllabusContent, assessmentContent] = await Promise.all([
          fetchMarkdown(syllabusUrl),
          fetchMarkdown(assessmentUrl, "No assessment selected."),
        ]);

        const res = await fetch("https://essayfeedback-bot.deno.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: combinedQuery,
            course: botMode.value,
            syllabus: syllabusContent,
            assessment: assessmentContent,
          }),
        });

        const text = await res.text();
        responseBox.textContent = text;
      } catch (err) {
        responseBox.textContent = "Error contacting server.";
      }
    });
  </script>
</body>
</html>
