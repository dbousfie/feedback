<!-- index.html (full file, no hardcoded “essay/paragraph” — everything comes from syllabus + assessment files) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Feedback Mechanism</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Lato', sans-serif; margin: 2rem; min-height: 100vh; }
    h1, h2 { color: #4F2683; }
    button {
      font-size: 1.0rem; font-weight: bold; padding: 0.6rem 1.3rem;
      background-color: #7e57c2; color: white; border: none; border-radius: 6px; cursor: pointer;
    }
    button:hover { background-color: #6a4bb3; }
    select { font-size: 1.0rem; margin-left: 0.5rem; }
    .selector-row { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 0.5rem; }
    .input-group { display: flex; gap: 2rem; align-items: flex-start; margin-bottom: 2rem; }
    .input-box, .sample-box { flex: 1; max-width: 600px; }
    textarea { font-family: monospace; width: 100%; }
    .sample-content {
      background: #f9f9f9; border: 1px solid #ccc; padding: 0.5rem;
      font-family: monospace; white-space: pre-wrap; max-height: 150px; overflow-y: auto; cursor: text;
    }
    #response {
      white-space: pre-wrap; margin-top: 1rem; padding: 1rem;
      background: #f4f4f4; border: 1px solid #ccc; max-width: 900px;
    }
    .muted { color: #666; font-size: 0.95rem; }
  </style>
</head>
<body>
  <h2>Feedback Mechanism</h2>

  <div class="selector-row">
    <label for="courseSelect"><strong>Select a course:</strong></label>
    <select id="courseSelect"></select>

    <label for="assessmentSelect"><strong>Select an assignment:</strong></label>
    <select id="assessmentSelect"></select>
  </div>

  <p id="contentStatus" style="margin-top: 0.5rem; color: #4F2683;"></p>
  <p class="muted">
    This page sends only three things to the server: your comments, your submission text, and the selected syllabus + assignment file contents.
    Nothing about “essay” or “paragraph” is hardcoded here.
  </p>

  <hr />

  <form id="queryForm">
    <div class="input-group">
      <div class="input-box">
        <label for="instructor">Reviewer Comments:</label><br />
        <textarea id="instructor" rows="4" cols="60" placeholder="Enter your comments here..."></textarea>
      </div>
      <div class="sample-box">
        <label>Sample Feedback:</label>
        <div class="sample-content" id="sampleFeedback">Loading sample feedback...</div>
      </div>
    </div>

    <div class="input-group">
      <div class="input-box">
        <label for="submission">Submission for review:</label><br />
        <textarea id="submission" rows="10" cols="60" placeholder="Paste the student submission here..."></textarea>
      </div>
      <div class="sample-box">
        <label>Sample Submission:</label>
        <div class="sample-content" id="sampleSubmission">Loading sample submission...</div>
      </div>
    </div>

    <button type="submit">Submit</button>
  </form>

  <h3>Response:</h3>
  <pre id="response"></pre>

  <script>
    const form = document.getElementById("queryForm");
    const responseBox = document.getElementById("response");
    const courseSelect = document.getElementById("courseSelect");
    const assessmentSelect = document.getElementById("assessmentSelect");
    const contentStatus = document.getElementById("contentStatus");

    const contentConfig = {
      syllabiPath: "syllabi",
      assessmentsPath: "assessments",
      samplePath: "sample",
      sampleSubmissionFile: "sample_submission.md",
      sampleFeedbackFile: "sample_feedback.md",
    };

    // Works on any host. Change these if your repo name/owner changes.
    const DEFAULT_GITHUB = { owner: "dbousfie", repo: "feedback", branch: "main" };

    const inferGitHubConfig = () => {
      const params = new URLSearchParams(window.location.search);
      const owner = params.get("owner");
      const repo = params.get("repo");
      const branch = params.get("branch");
      if (owner && repo) return { owner, repo, branch: branch || "main" };

      const host = window.location.hostname;
      const pathParts = window.location.pathname.split("/").filter(Boolean);

      // Pattern: https://OWNER.github.io/REPO/
      if (host.endsWith(".github.io")) {
        const inferredOwner = host.replace(".github.io", "");
        const inferredRepo = pathParts.length > 0 ? pathParts[0] : `${inferredOwner}.github.io`;
        return { owner: inferredOwner, repo: inferredRepo, branch: "main" };
      }

      return DEFAULT_GITHUB;
    };

    const github = inferGitHubConfig();

    const setStatus = (msg) => { contentStatus.textContent = msg; };

    const setSelectOptions = (select, options, placeholder) => {
      select.innerHTML = "";
      if (!options.length) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = placeholder;
        opt.disabled = true;
        opt.selected = true;
        select.appendChild(opt);
        select.disabled = true;
        return;
      }
      select.disabled = false;
      options.forEach((o, i) => {
        const opt = document.createElement("option");
        opt.value = o.value;
        opt.textContent = o.label;
        if (i === 0) opt.selected = true;
        select.appendChild(opt);
      });
    };

    const fetchText = async (url) => {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error("fetch failed");
      return res.text();
    };

    const fetchFolderMarkdownFiles = async (path) => {
      const cacheBuster = Date.now();
      const apiUrl =
        `https://api.github.com/repos/${github.owner}/${github.repo}/contents/${path}?ref=${github.branch}&cache=${cacheBuster}`;

      const res = await fetch(apiUrl, { cache: "no-store" });
      if (!res.ok) throw new Error(`Cannot load ${path} from ${github.owner}/${github.repo} (${github.branch}).`);

      const data = await res.json();
      return data.filter((item) => item.type === "file" && item.name.endsWith(".md"));
    };

    const loadTextInto = async (path, elementId, fallback) => {
      try {
        const text = await fetchText(path);
        document.getElementById(elementId).textContent = text;
      } catch {
        document.getElementById(elementId).textContent = fallback;
      }
    };

    const loadSamples = () => {
      loadTextInto(
        `./${contentConfig.samplePath}/${contentConfig.sampleFeedbackFile}`,
        "sampleFeedback",
        "Sample feedback not available."
      );
      loadTextInto(
        `./${contentConfig.samplePath}/${contentConfig.sampleSubmissionFile}`,
        "sampleSubmission",
        "Sample submission not available."
      );
    };

    let syllabusUrlByCourse = new Map(); // courseCode -> download_url
    let assessmentUrlByName = new Map(); // fileBaseName -> download_url

    const loadOptions = async () => {
      setStatus(`Loading from ${github.owner}/${github.repo} (${github.branch})...`);

      setSelectOptions(courseSelect, [], "Loading courses...");
      setSelectOptions(assessmentSelect, [], "Loading assignments...");

      const [syllabi, assessments] = await Promise.all([
        fetchFolderMarkdownFiles(contentConfig.syllabiPath),
        fetchFolderMarkdownFiles(contentConfig.assessmentsPath),
      ]);

      syllabusUrlByCourse = new Map();
      const courseOptions = syllabi.map((item) => {
        // expects: 3201syllabus.md
        const course = item.name.replace(/syllabus\.md$/i, "");
        syllabusUrlByCourse.set(course, item.download_url);
        return { value: course, label: course };
      });

      assessmentUrlByName = new Map();
      const assessmentOptions = assessments.map((item) => {
        // expects: 3201.md, media_analysis.md, etc.
        const base = item.name.replace(/\.md$/i, "");
        assessmentUrlByName.set(base, item.download_url);
        return { value: base, label: base };
      });

      setSelectOptions(courseSelect, courseOptions, "No courses found.");
      setSelectOptions(assessmentSelect, assessmentOptions, "No assignments found.");
      setStatus("Loaded.");
    };

    loadSamples();
    loadOptions().catch((err) => {
      setStatus(String(err.message || err));
      responseBox.textContent = "Error loading files.";
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      responseBox.textContent = "Loading...";

      const reviewerComments = document.getElementById("instructor").value || "";
      const submissionText = document.getElementById("submission").value || "";

      const course = courseSelect.value;
      const assignmentKey = assessmentSelect.value;

      const syllabusUrl = syllabusUrlByCourse.get(course);
      const assessmentUrl = assessmentUrlByName.get(assignmentKey);

      try {
        const [syllabusContent, assessmentContent] = await Promise.all([
          syllabusUrl ? fetchText(syllabusUrl) : Promise.resolve(""),
          assessmentUrl ? fetchText(assessmentUrl) : Promise.resolve(""),
        ]);

        // IMPORTANT: No “essay”, no “paragraph” hardcoded.
        // The model is instructed to infer what it is from the assignment file.
     const query = [
  "db2025",
  "Output plain text only. If you use bullets, use hyphens like '- ' only. No Markdown headings or bold.",

          "Use ONLY the syllabus and assignment text below to decide what kind of submission this is and how to evaluate it.",
          "Do not assume it is an essay unless the assignment says it is an essay.",
        "Do NOT include any grades, scores, percentages, points, or numeric evaluation anywhere.",
      "Do NOT write 'Grade:' or 'Score:' or any numbers meant as evaluation.",
      "Match the format required by the ASSIGNMENT file. If it requires short margin notes, do that. If it requires substantive engagement, do that.",

          "",
          "Reviewer Comments (authoritative):",
          reviewerComments,
          "",
          "Student Submission (as provided):",
          submissionText,
          "",
          "Return structured feedback using the categories/rubric described in the assignment file. If the assignment file does not define categories, use the six db2025 categories.",
        ].join("\n");

        const res = await fetch("https://essayfeedback-bot.deno.dev/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            course,
            query,
            syllabus: syllabusContent,
            assessment: assessmentContent,
          }),
        });

        const text = await res.text();
        responseBox.textContent = text;
      } catch {
        responseBox.textContent = "Error contacting server.";
      }
    });
  </script>
</body>
</html>
